<!DOCTYPE html>
<html>
<head>
  <script src="processing-1.3.6-api.js"></script>
  <title>Delaunay Triangulation</title>
  
<body>
	<h2>DelaunAy triangulation!</h2>
<p>
click to add points, spacebar afterwards for faster insertion
<button onclick="javascript:drawMode = !drawMode">Draw mode</button>
<button onclick="javascript:toggleRandPoints()">Random Points</button>
</p>
<link href="style.css" rel="stylesheet" type="text/css"/>

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js"></script>
<script type="text/javascript" src="jquery.min.js"></script>
<script type="text/javascript" src="geoLibrary.js"></script>
<script type="text/javascript" src="sylvester.src.js"></script>
<script type="text/javascript">

/*********Globals**********/

$j = jQuery.noConflict();
var fileText;
var canvas;
var p;

var theEdge = null;
var theTri = null;
var pointBuffer = [];
var drawMode = true;
var fileMode = false;
var onRandomPoints = false;
var randomPointTimeout = null;

var allVertices = {};
var allLinks = {};

var maxVertexX = Number.MIN_VALUE;
var maxVertexY = Number.MIN_VALUE;
var minVertexX = Number.MAX_VALUE;
var minVertexY = Number.MAX_VALUE;


function eraseCircle() {
	circle.radius = 0;
	circle.x = -10;
}


function sketchProc(processing) {
  // Override draw function, by default it will be called 60 times per second
    processing.draw = function() {

        // erase background
        p.background(224);
        
        if(theEdge)
        { theEdge.draw(); }
        if(theTri)
        {
            //theTri.drawBoth();
        }
        for(var i = 0; i < pointBuffer.length; i++)
        {
            pointBuffer[i].draw();
        }
        //draw mode
        fLibrary.drawAllTris(drawMode);
        for(key in highlightedEdges)
        {
            highlightedEdges[key].draw();
        }
    };
    
    processing.setup = function() {
        processing.width = 800;
        processing.height = 600;
        processing.background(224)

		var a = processing.loadFont('Courier New');
		processing.textFont(a,36);
		processing.textAlign(processing.CENTER);

    };

    processing.mouseDragged = function() {
	    if(p.__mousePressed)
        {
		   //p.mouseClicked();
        }
    };

    processing.keyPressed = function() {

        if(p.keyCode == 32) // space
        {
            var p1 = new Point(p.mouseX,p.mouseY);
            insertAnyPoint(p1);
        }
    }
    
    processing.mouseClicked = function() {
        //console.log("button" + p.mouseButton);

        if(p.mouseButton == 37)
        {
            //left click
            //make a new point here, test the left or right test
            var x = p.mouseX;
            var y = p.mouseY;

            var toInsert = null;
            if(fileMode)
            {
                //need to convert this x and y into file coordinates
                x = x - 0.1 * p.width;
                x = x / (0.8 * p.width);
                x = x * (maxVertexX - minVertexX);

                y = y - 0.1 * p.height;
                y = y / (0.8 * p.height);
                y = y * (maxVertexY - minVertexY);

                var id = Math.round(Math.random() * 10000);
                toInsert = new Vertex(id,x,y);
            }
            else
            {
                toInsert = new Point(x,y);
            }

            pointBuffer.push(toInsert);
            if(pointBuffer.length == 3)
            {
                p1 = pointBuffer[0];
                p2 = pointBuffer[1];
                p3 = pointBuffer[2];
                //pointBuffer = [];
                var tri = new Triangle(p1,p2,p3);
                fLibrary.addTri(tri);
            }
            else
            {
                insertAnyPoint(toInsert);
            }
        }
        else if(p.mouseButton == 39)
        {
            //right click
            var p1 = new Point(p.mouseX,p.mouseY);

            fLibrary.highlightTrisContainingPoint(p1);
        }
        else if(p.mouseButton == 3)
        {
            //middle click? this is actually right

        }

    };
}

function toggleRandPoints()
{
    if(!onRandomPoints)
    {
        onRandomPoints = true;
        randomPoints();
    }
    else
    {
        onRandomPoints = false;
        clearTimeout(randomPointTimeout);
    }
}

function randomPoints()
{
	var p1 = randPoint();
	insertAnyPoint(p1);

	randomPointTimeout = setTimeout("randomPoints()",200);
}

function outputFile()
{
    var text = fLibrary.outputFile();
    $j('#outputFile').val(text);
}

function loadFile()
{
    fileText = $j('#inputFile').val();

    var numVerticesResult = /(\d+)/.exec(fileText);
    if(!numVerticesResult)
    {
        alert("something seems to be wrong with your file input");
        return;
    }
    var numVertices = numVerticesResult[0];
    console.log("number of vertices :" + numVertices);
    
    var lines = fileText.split('\n');
    lines.splice(0,1);
    
    //delete the existing library 
    fLibrary = new fullLibrary();
    pointBuffer = [];

    readInVertices(numVertices,lines);
}

function readInVertices(numVertices,lines)
{
    maxVertexX = Number.MIN_VALUE;
    maxVertexY = Number.MIN_VALUE;
    minVertexX = Number.MAX_VALUE;
    minVertexY = Number.MAX_VALUE;

    var numVertices = 0;
    var vBuffer = [];
    fileMode = true;

    allVertices = {};

    var regex = /\s*(\d+)\s+([-e+.0-9]+)\s+([-e+.0-9]+)/;
    //get min and max
    for(var i = 0; i <= lines.length; i++)
    {
        var theLine = lines[i];

        //regex for (1 - number of vertex) (2- x coord) (3- y coord)
        var results = regex.exec(theLine);

        if(!results)
        {
            continue;
        }

        var vertexNum = Number(results[1]);
        var xCoord = Number(results[2]);
        var yCoord = Number(results[3]);

        if(xCoord > maxVertexX)
        {
            maxVertexX = xCoord;
        }
        if(xCoord < minVertexX)
        {
            minVertexX = xCoord;
        }
        if(yCoord < minVertexY)
        {
            minVertexY = yCoord;
        }
        if(yCoord > maxVertexY)
        {
            maxVertexY = yCoord;
        }
    }

     
    console.log("lines length is ", lines.length);
    //read in vertices
    for(var i = 0; i <= lines.length; i++)
    {
        var theLine = lines[i];

        //regex for (1 - number of vertex) (2- x coord) (3- y coord)
        var results = regex.exec(theLine);

        if(!results)
        {
            continue;
        }

        var vertexNum = Number(results[1]);
        var xCoord = Number(results[2]);
        var yCoord = Number(results[3]);

        //make a new vertex and assign it
        var newlyMade = new Vertex(vertexNum,xCoord,yCoord);
        allVertices[vertexNum] = newlyMade;
        numVertices++;
        vBuffer.push(newlyMade);

        if(numVertices == 3)
        {
            var tri = new Triangle(vBuffer[0],vBuffer[1],vBuffer[2]);
            fLibrary.addTri(tri);
        }
        else if(numVertices > 3)
        {
            //console.log("inserting point", newlyMade.id);
            insertAnyPoint(newlyMade);
        }
    }
}


$j(document).ready(function(){
    canvas = document.getElementById("canvas1");
    p = new Processing(canvas, sketchProc);
    
    var p1 = randPoint();
    var p2 = randPoint();
	var p3 = randPoint();
    
    theTri = new Triangle(p1,p2,p3);

    //theEdge = new Edge(p1,p2);
    fLibrary = new fullLibrary();
    //fLibrary.addTri(theTri);
	//pointBuffer.length = 3;
	//randomPoints();


    var testFile = "12 2 0 0\n1 0 0\n2 0 3\n3 3 0\n 4 3 3\n5 1 1 \n 6 1 2\n7 2 1 \n 8 2 2 \n 9 0 1.5\n 10 1.5 0\n11 3 1.5\n 12 1.5 3";
    $j('#inputFile').val(testFile);
    //loadFile();

});


</script>
<div style="text-align:center;">
    <canvas id="canvas1" width="600" height="800"></canvas></p>

    <table>
        <tr>
            <td>
    <textarea id="inputFile" rows="4" cols="80">Enter your .node file here
    </textarea>
            </td>
            <td>
                <div style="width:30px"></div>
            </td>
            <td>
    <textarea id="outputFile" rows="4" cols="80">Output area
    </textarea>
            </td>
        </tr>
        <tr>
            <td>
                <button onclick="javascript:loadFile()">Load File</button>
            </td>
            <td>
                <button onclick="javascript:outputFile()">Output File</button>
            </td>
        </tr>
        
    </table>

</div>

</body>
</html>
